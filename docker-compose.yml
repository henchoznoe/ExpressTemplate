#
# Copyright (c) 2025 Noé Henchoz
# Author: Noé Henchoz
# File: docker-compose.yml
# Title: Docker Compose Configuration
# Description: Docker Compose file to set up the Express API service and PostgreSQL database.
# Last modified: 2025-11-21
#

services:
    # --- Express API Service ---
    # Only used when running the full stack in Docker (e.g. strictly for testing the image)
    express_template:
        build: .
        container_name: express-template
        restart: unless-stopped
        env_file:
            - .env
        environment:
          # OVERRIDE: Force connection to the 'postgres' service container instead of localhost
          - DATABASE_URL=postgresql://${DB_USER:-dev_user}:${DB_PASSWORD:-dev_password}@postgres:5432/${DB_NAME:-dev_db}?schema=public
          - DIRECT_URL=postgresql://${DB_USER:-dev_user}:${DB_PASSWORD:-dev_password}@postgres:5432/${DB_NAME:-dev_db}?schema=public
        # Port mapping (HOST:CONTAINER)
        ports:
          - '${PORT:-3000}:${PORT:-3000}'
        # Volume mapping (HOST:CONTAINER)
        volumes:
            - ./logs:/app/logs
        depends_on:
          postgres:
            condition: service_healthy

    # --- PostgreSQL Database Service ---
    # A local, isolated database for development.
    postgres:
      image: postgres:18-alpine
      container_name: express-template-db
      restart: unless-stopped
      environment:
        POSTGRES_USER: ${DB_USER:-dev_user}
        POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password}
        POSTGRES_DB: ${DB_NAME:-dev_db}
      ports:
        - '5432:5432'
      volumes:
        - postgres_data:/var/lib/postgresql/data
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-dev_user} -d ${DB_NAME:-dev_db}" ]
        interval: 5s
        timeout: 5s
        retries: 5

volumes:
  postgres_data:
