# @file docker-compose.yml
# @title Docker Compose Configuration
# @description Docker Compose file to set up the Express API service and PostgreSQL database.
# @author Noé Henchoz
# @date 2025-12-02
# @license MIT
# @copyright (c) 2025 Noé Henchoz

services:
    # --- Express API Service ---
    # In Production: Runs the API connected to the DB defined in .env
    express_template:
        build: .
        container_name: express-template
        restart: unless-stopped
        env_file:
            - .env
        # Port mapping (HOST:CONTAINER)
        ports:
          - '${PORT:-3000}:${PORT:-3000}'
        # Volume mapping (HOST:CONTAINER)
        volumes:
            - ./logs:/app/logs

    # --- PostgreSQL Database Service ---
    # In Development: Used by 'npm run db:up' to provide a local DB.
    # In Production: Ignored if using an external DB (Supabase, RDS, etc).
    postgres:
      image: postgres:18-alpine
      container_name: express-template-db
      restart: unless-stopped
      environment:
        POSTGRES_USER: ${DB_USER:-dev_user}
        POSTGRES_PASSWORD: ${DB_PASSWORD:-dev_password}
        POSTGRES_DB: ${DB_NAME:-dev_db}
      ports:
        - '5432:5432'
      volumes:
        - postgres_data:/var/lib/postgresql/data
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-dev_user} -d ${DB_NAME:-dev_db}" ]
        interval: 5s
        timeout: 5s
        retries: 5

volumes:
  postgres_data:
